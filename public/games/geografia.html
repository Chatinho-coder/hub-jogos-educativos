<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>GeoMestre Brasil</title>
<script src="https://cdn.jsdelivr.net/npm/d3-array@3"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-geo@3"></script>
<style>
:root {
  color-scheme: light;
  font-family: Inter, -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', sans-serif;
  --bg: #f4f5f7;--surface: #ffffff;--surface-soft: #f8f9fb;--text: #17181c;--muted: #5f6673;--line: #d8dce3;
  --accent: #2f6df6;--accent-strong: #2557c7;--highlight: #b8d2ff;
  --radius-s: 10px;--radius-m: 16px;--radius-l: 24px;
  --space-1: 0.5rem;--space-2: 0.75rem;--space-3: 1rem;--space-4: 1.5rem;--space-5: 2rem;
  --shadow-1: 0 8px 24px rgba(12,16,27,0.06);--shadow-2: 0 18px 40px rgba(17,22,36,0.08);
}
*{box-sizing:border-box}
body{margin:0;color:var(--text);background:radial-gradient(circle at top right,#fff,#f1f3f8 45%,#eceff5);min-height:100vh}
body.game-active{overflow:hidden;overscroll-behavior:none}
body.answer-sheet-open{overflow:hidden;overscroll-behavior:none}
.container{width:min(1040px,100% - 2rem);margin:0 auto;padding:var(--space-5) 0 calc(var(--space-5) + var(--space-2));display:grid;gap:var(--space-4)}
.game-container{height:100dvh;max-height:100dvh;overflow:hidden;padding-top:max(0.8rem,env(safe-area-inset-top));padding-bottom:max(0.8rem,env(safe-area-inset-bottom));gap:var(--space-2)}
.panel{background:color-mix(in srgb,var(--surface) 94%,transparent);border:1px solid color-mix(in srgb,var(--line) 75%,white);border-radius:var(--radius-l);padding:clamp(1rem,1.2vw + 0.9rem,2rem);box-shadow:var(--shadow-1);backdrop-filter:blur(12px)}
.hero{display:grid;gap:var(--space-3);box-shadow:var(--shadow-2)}
.game-hero{gap:var(--space-2);padding-block:0.72rem}
.game-title-row{display:flex;align-items:center;justify-content:space-between;gap:0.6rem}
.eyebrow{margin:0;text-transform:uppercase;letter-spacing:0.08em;font-size:0.76rem;font-weight:700;color:var(--accent)}
h1,h2,h3,p{margin:0}
h1{font-size:clamp(1.7rem,2.2vw + 1rem,2.7rem);line-height:1.1;letter-spacing:-0.025em}
h2{font-size:clamp(1.05rem,1vw + 0.9rem,1.55rem);letter-spacing:-0.015em}
h3{font-size:1.1rem;letter-spacing:-0.01em}
.muted{color:var(--muted);line-height:1.4}
.hud{display:flex;flex-wrap:wrap;gap:var(--space-2)}
.chip{display:grid;gap:0.1rem;padding:0.52rem 0.78rem;border-radius:999px;border:1px solid var(--line);background:var(--surface-soft);min-width:5.4rem}
.chip strong{font-size:1rem;line-height:1}
.chip small{font-size:0.68rem;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted)}
.progress{position:relative;height:0.45rem;border-radius:999px;background:#e3e6ee;overflow:hidden}
.progress span{position:absolute;inset:0 auto 0 0;border-radius:inherit;background:linear-gradient(90deg,var(--accent),#7aa5ff);transition:width 260ms ease}
.game-panel{display:grid;grid-template-rows:auto minmax(180px,1fr) auto auto;gap:var(--space-2);min-height:0;overflow:hidden}
.round-title{display:flex;align-items:baseline;justify-content:space-between;gap:0.75rem}
.map-panel{border-radius:var(--radius-m);padding:var(--space-2);border:1px solid var(--line);background:linear-gradient(180deg,#f5f8ff,#eef2f8)}
.game-map-panel{min-height:0;display:grid;margin:0}
.mapa{width:100%;max-height:62vh;border-radius:calc(var(--radius-m) - 2px);display:block}
.game-map-panel .mapa{max-height:min(58dvh,440px)}
.estado{fill:#c7d0dd;stroke:#f6f9ff;stroke-width:0.9;cursor:pointer;transition:fill 160ms ease,transform 160ms ease,stroke 160ms ease}
.estado:hover{fill:#9eb2ce}
.estado.destacado{fill:var(--highlight);stroke:color-mix(in srgb,var(--accent) 75%,#162039);stroke-width:1.5}
.feedback{min-height:1.5rem;color:#1d324f;font-weight:600}
.cta-wrap{display:grid;grid-template-columns:1fr}
.review-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:var(--space-2);margin-top:var(--space-3)}
.review-item{display:grid;gap:0.25rem;background:var(--surface-soft);border:1px solid var(--line);border-radius:var(--radius-s);padding:0.8rem}
.summary-grid{margin-bottom:var(--space-3)}
.fields-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:var(--space-3)}
.answer-fields{grid-template-columns:1fr}
label{display:grid;gap:0.4rem;font-weight:600;font-size:1rem}
.option-group{margin:0;padding:0;border:0;min-width:0}
.option-group legend{font-weight:650;font-size:1rem;margin-bottom:0.55rem}
.option-buttons{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:0.55rem}
.option-btn{border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--text);font:inherit;font-size:1rem;font-weight:560;min-height:48px;padding:0.7rem 0.75rem;cursor:pointer;text-align:left;transition:border-color 150ms ease,box-shadow 150ms ease,background-color 150ms ease,transform 120ms ease;touch-action:manipulation}
.option-btn:hover{border-color:#b8c7e3;transform:translateY(-1px)}
.option-btn.is-selected{border-color:var(--accent);background:color-mix(in srgb,var(--accent) 13%,#fff);color:color-mix(in srgb,var(--accent-strong) 92%,#101e3b);box-shadow:0 0 0 2px color-mix(in srgb,var(--accent) 25%,transparent)}
input,select,.btn{border-radius:12px;border:1px solid var(--line);background:white;color:var(--text);min-height:48px;padding:0.78rem 0.92rem;font-size:16px;font-family:inherit;transition:border-color 150ms ease,box-shadow 150ms ease,transform 120ms ease,background-color 150ms ease;touch-action:manipulation}
input:hover,select:hover{border-color:#bbc4d3}
.btn{cursor:pointer;width:fit-content;font-weight:650}
.btn-answer{width:100%;font-size:1.05rem;min-height:52px}
.btn-quiet{min-height:44px;min-width:44px;padding:0;border-radius:999px;font-size:1.6rem;line-height:1;display:grid;place-items:center}
.btn:disabled{opacity:0.55;cursor:not-allowed}
.btn-primary{border-color:var(--accent);background:linear-gradient(180deg,#3e7cff,#2f6df6);color:white;box-shadow:0 7px 20px rgba(47,109,246,0.26)}
.btn-primary:hover:not(:disabled){transform:translateY(-1px);background:linear-gradient(180deg,#4b86ff,#3169e8)}
.btn-secondary,.btn-quiet{background:#fff}
.actions-row{display:flex;flex-wrap:wrap;gap:var(--space-2)}
.overlay{position:fixed;inset:0;z-index:50;background:rgba(10,15,25,0.44);backdrop-filter:blur(5px);display:grid;place-items:center;padding:1rem}
.answer-overlay{align-items:stretch;padding:0}
.overlay-panel{width:min(520px,100%);display:grid;gap:1rem}
.answer-panel{width:100%;height:100dvh;max-height:100dvh;border-radius:0;padding-top:max(1rem,env(safe-area-inset-top));padding-bottom:max(1rem,env(safe-area-inset-bottom));overflow:auto}
.overlay-head{display:flex;justify-content:space-between;align-items:center;gap:0.75rem}
.question-mini-state{display:grid;place-items:center;min-height:120px;margin-top:-0.2rem;margin-bottom:-0.1rem}
.mini-state{width:min(120px,34vw);height:auto;display:block}
.mini-state-shape{fill:color-mix(in srgb,var(--highlight) 80%,white);stroke:color-mix(in srgb,var(--accent) 70%,#1d2c4d);stroke-width:2.5}
.answer-actions{display:grid;grid-template-columns:1fr 1fr;gap:0.65rem}
.overlay-actions{display:grid;gap:0.6rem}
button:focus-visible,select:focus-visible,input:focus-visible,.option-btn:focus-visible,.estado:focus-visible{outline:3px solid color-mix(in srgb,var(--accent) 45%,#8db3ff);outline-offset:2px}
@media(max-width:760px){
  .container{width:min(100% - 0.8rem,1040px);padding-top:var(--space-3);gap:var(--space-3)}
  .game-container{width:min(100% - 0.3rem,1040px);padding-top:max(0.45rem,env(safe-area-inset-top));padding-bottom:max(0.45rem,env(safe-area-inset-bottom));gap:0.5rem}
  .game-hero{padding:0.62rem}
  .game-panel{padding:0.7rem;gap:0.55rem}
  .chip{min-width:4.8rem;padding:0.45rem 0.65rem}
  .answer-panel{padding-inline:0.85rem}
  .btn,.actions-row,.answer-actions{width:100%}
  .actions-row{display:grid;grid-template-columns:1fr}
}
@media(prefers-color-scheme:dark){
  :root{color-scheme:dark;--bg:#101217;--surface:#171a21;--surface-soft:#1e2330;--text:#e8ecf6;--muted:#adb6c9;--line:#2c3444;--highlight:#4867a5;--shadow-1:0 10px 24px rgba(0,0,0,0.34);--shadow-2:0 20px 40px rgba(0,0,0,0.42)}
  body{background:radial-gradient(circle at top right,#1a1f2c,#0f1219 55%,#0b0e13)}
  .panel{background:color-mix(in srgb,var(--surface) 92%,transparent);border-color:color-mix(in srgb,var(--line) 78%,#3a455f)}
  input,select,.btn,.btn-secondary,.btn-quiet,.option-btn{background:#121722;border-color:var(--line);color:var(--text)}
  .option-btn.is-selected{background:color-mix(in srgb,var(--accent) 22%,#121722);color:#dce8ff}
  .chip,.review-item{background:#141a27}
  .mini-state-shape{fill:color-mix(in srgb,var(--highlight) 75%,#2b3d63);stroke:#86afff}
  .map-panel{background:linear-gradient(180deg,#1a2231,#141b29)}
  .estado{fill:#5d6780;stroke:#111623}
  .estado:hover{fill:#7380a2}
  .feedback{color:#c6d9ff}
}
</style>
</head>
<body>
<div id="app"></div>
<script>
const STATES_DATA=[
  {uf:'AC',estado:'Acre',capital:'Rio Branco',dica:'ACre lembra ARROZ BRANCO → Rio Branco.'},
  {uf:'AL',estado:'Alagoas',capital:'Maceió',dica:'ALAGOAS rima com "LAGOA", mas a capital é Maceió.'},
  {uf:'AP',estado:'Amapá',capital:'Macapá',dica:'Amapá e Macapá: quase gêmeas no nome.'},
  {uf:'AM',estado:'Amazonas',capital:'Manaus',dica:'No Amazonas, a capital é Manaus (zona franca).'},
  {uf:'BA',estado:'Bahia',capital:'Salvador',dica:'Bahia tem Salvador como porta histórica do Brasil.'},
  {uf:'CE',estado:'Ceará',capital:'Fortaleza',dica:'Ceará → Fortaleza (cidade forte no nome).'},
  {uf:'DF',estado:'Distrito Federal',capital:'Brasília',dica:'DF é o coração político: Brasília.'},
  {uf:'ES',estado:'Espírito Santo',capital:'Vitória',dica:'Espírito Santo vence com Vitória.'},
  {uf:'GO',estado:'Goiás',capital:'Goiânia',dica:'Goiás e Goiânia compartilham a raiz "Goi".'},
  {uf:'MA',estado:'Maranhão',capital:'São Luís',dica:'Maranhão: ilha histórica de São Luís.'},
  {uf:'MT',estado:'Mato Grosso',capital:'Cuiabá',dica:'Mato Grosso e calor de Cuiabá.'},
  {uf:'MS',estado:'Mato Grosso do Sul',capital:'Campo Grande',dica:'MS: Campo Grande é a capital "grande" do centro-oeste.'},
  {uf:'MG',estado:'Minas Gerais',capital:'Belo Horizonte',dica:'Minas tem horizonte belo em BH.'},
  {uf:'PA',estado:'Pará',capital:'Belém',dica:'No Pará, o Círio acontece em Belém.'},
  {uf:'PB',estado:'Paraíba',capital:'João Pessoa',dica:'Paraíba → João Pessoa (JP).'},
  {uf:'PR',estado:'Paraná',capital:'Curitiba',dica:'Paraná é terra de Curitiba.'},
  {uf:'PE',estado:'Pernambuco',capital:'Recife',dica:'Pernambuco e os recifes de Recife.'},
  {uf:'PI',estado:'Piauí',capital:'Teresina',dica:'Piauí termina com "í"; a capital é Teresina.'},
  {uf:'RJ',estado:'Rio de Janeiro',capital:'Rio de Janeiro',dica:'No RJ, estado e capital têm o mesmo nome.'},
  {uf:'RN',estado:'Rio Grande do Norte',capital:'Natal',dica:'No Norte do RN, "nasce" Natal.'},
  {uf:'RS',estado:'Rio Grande do Sul',capital:'Porto Alegre',dica:'No Sul, o porto é Alegre.'},
  {uf:'RO',estado:'Rondônia',capital:'Porto Velho',dica:'Rondônia: porto mais velho, Porto Velho.'},
  {uf:'RR',estado:'Roraima',capital:'Boa Vista',dica:'Roraima tem uma Boa Vista do norte.'},
  {uf:'SC',estado:'Santa Catarina',capital:'Florianópolis',dica:'Santa Catarina: ilha de Florianópolis.'},
  {uf:'SP',estado:'São Paulo',capital:'São Paulo',dica:'Em SP, estado e capital têm o mesmo nome.'},
  {uf:'SE',estado:'Sergipe',capital:'Aracaju',dica:'Sergipe no litoral: Aracaju.'},
  {uf:'TO',estado:'Tocantins',capital:'Palmas',dica:'Tocantins bate palmas para Palmas.'}
];
const STATES_BY_NAME=Object.fromEntries(STATES_DATA.map(s=>[s.estado,s]));
const MAX_ERRORS=5;
function shuffle(a){return[...a].sort(()=>Math.random()-0.5)}
function normalizeText(t=''){return t.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim().replace(/\s+/g,' ')}
function isCorrectAnswer(i,e){return normalizeText(i)===normalizeText(e)}
function scoreRound({stateOk,capitalOk,streak}){const bs=stateOk?10:0,bc=capitalOk?15:0,sb=stateOk&&capitalOk?Math.min(streak*2,20):0;return{points:bs+bc+sb,streakBonus:sb}}
function getOptions(cur,key){return shuffle([cur[key],...shuffle(STATES_DATA.filter(s=>s.uf!==cur.uf)).slice(0,3).map(s=>s[key])])}

let geojson=null, projection=null, pathGen=null;
let timerHandle=null;
const GAME_TIME=180;
let state={mode:'loading',queue:[],index:0,score:0,streak:0,errors:0,timeLeft:GAME_TIME,feedback:'',wrongAnswers:[],stateAnswer:'',capitalAnswer:'',stateOptions:[],capitalOptions:[],showAnswerSheet:false,showOptions:false};

async function init(){
  const r=await fetch('/games/brazil-states.json');
  geojson=await r.json();
  projection=d3.geoMercator().fitSize([600,620],geojson);
  pathGen=d3.geoPath(projection);
  state.mode='menu';
  render();
}

function el(id){return document.getElementById(id)}
function h(tag,attrs,...children){
  const e=document.createElement(tag);
  if(attrs)Object.entries(attrs).forEach(([k,v])=>{
    if(v==null||v===false)return;
    if(k==='className')e.className=v;
    else if(k==='style'&&typeof v==='object')Object.assign(e.style,v);
    else if(k.startsWith('on'))e.addEventListener(k.slice(2).toLowerCase(),v);
    else if(v===true)e.setAttribute(k,'');
    else e.setAttribute(k,String(v));
  });
  children.flat().forEach(c=>{if(c!=null)e.append(typeof c==='string'?c:c)});
  return e;
}

function createRoundOptions(cur){
  if(!cur)return{stateOptions:[],capitalOptions:[]};
  return{
    stateOptions:getOptions(cur,'estado'),
    capitalOptions:getOptions(cur,'capital')
  };
}

function renderMap(container,highlighted,onClick,focusable){
  const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('viewBox','0 0 600 620');
  svg.classList.add('mapa');
  svg.setAttribute('role','img');
  svg.setAttribute('aria-label','Mapa interativo do Brasil');
  geojson.features.forEach(f=>{
    const name=f.properties?.name;
    const path=document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d',pathGen(f));
    path.classList.add('estado');
    if(name===highlighted)path.classList.add('destacado');
    path.setAttribute('aria-label',name);
    if(focusable)path.setAttribute('tabindex','0');
    if(onClick){
      path.addEventListener('click',()=>onClick(name));
      if(focusable)path.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();onClick(name)}});
    }
    svg.appendChild(path);
  });
  container.appendChild(svg);
}

function renderMiniState(container,stateName){
  const feature=geojson.features.find(f=>f.properties?.name===stateName);
  if(!feature)return;
  const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('viewBox','0 0 200 200');
  svg.classList.add('mini-state');
  const rawPath=pathGen(feature);
  const [[x0,y0],[x1,y1]]=pathGen.bounds(feature);
  const w=Math.max(1,x1-x0),ht=Math.max(1,y1-y0);
  const sc=Math.min(152/w,152/ht);
  const tx=(200-w*sc)/2-x0*sc,ty=(200-ht*sc)/2-y0*sc;
  const path=document.createElementNS('http://www.w3.org/2000/svg','path');
  path.setAttribute('d',rawPath||'');
  path.setAttribute('transform',`translate(${tx} ${ty}) scale(${sc})`);
  path.classList.add('mini-state-shape');
  svg.appendChild(path);
  container.appendChild(svg);
}

function resetGame(newMode='menu'){
  const queue=shuffle(STATES_DATA);
  const firstRoundOptions=createRoundOptions(queue[0]);
  if(timerHandle){clearInterval(timerHandle);timerHandle=null;}
  state={mode:newMode,queue,index:0,score:0,streak:0,errors:0,timeLeft:GAME_TIME,feedback:'',wrongAnswers:[],stateAnswer:'',capitalAnswer:'',stateOptions:firstRoundOptions.stateOptions,capitalOptions:firstRoundOptions.capitalOptions,showAnswerSheet:false,showOptions:false};
  if(newMode==='game'){
    timerHandle=setInterval(()=>{
      if(state.mode!=='game') return;
      state.timeLeft=Math.max(0,state.timeLeft-1);
      if(state.timeLeft<=0){ state.errors=MAX_ERRORS; }
      render();
    },1000);
  }
  document.body.classList.remove('game-active','answer-sheet-open');
  render();
}

function submitRound(){
  const cur=state.queue[state.index];
  const sOk=isCorrectAnswer(state.stateAnswer,cur.estado);
  const cOk=isCorrectAnswer(state.capitalAnswer,cur.capital);
  const round=scoreRound({stateOk:sOk,capitalOk:cOk,streak:state.streak});
  if(sOk&&cOk){
    state.score+=round.points;state.streak++;
    state.feedback=`✅ Perfeito! +${round.points} pontos (bônus: ${round.streakBonus})`;
  }else{
    state.errors++;state.streak=0;
    state.wrongAnswers.push({estado:cur.estado,capital:cur.capital});
    state.feedback=`❌ Correto: ${cur.estado} — ${cur.capital}. Dica: ${cur.dica}`;
    state.score+=round.points;
  }
  state.showAnswerSheet=false;
  document.body.classList.remove('answer-sheet-open');
  setTimeout(()=>{
    state.index++;state.stateAnswer='';state.capitalAnswer='';
    const nextRoundOptions=createRoundOptions(state.queue[state.index]);
    state.stateOptions=nextRoundOptions.stateOptions;
    state.capitalOptions=nextRoundOptions.capitalOptions;
    // Send score when game ends
    if((state.errors>=MAX_ERRORS||state.index>=state.queue.length||state.timeLeft<=0)&&window.parent!==window){
      const finalScore=state.score+Math.max(0,state.timeLeft)*2;
      window.parent.postMessage({type:'game-score',game:'geografia',score:finalScore},'*');
    }
    render();
  },450);
  render();
}

function render(){
  const app=el('app');
  app.innerHTML='';
  const ended=state.errors>=MAX_ERRORS||state.index>=state.queue.length||state.timeLeft<=0;
  if(ended&&timerHandle){clearInterval(timerHandle);timerHandle=null;}
  document.body.classList.toggle('game-active',state.mode==='game'&&!ended);

  if(state.mode==='loading'){
    app.appendChild(h('main',{className:'container'},h('section',{className:'panel'},h('p',{className:'muted'},'Carregando mapa...'))));
    return;
  }

  if(state.mode==='menu'){
    app.appendChild(h('main',{className:'container'},
      h('section',{className:'hero panel'},
        h('p',{className:'eyebrow'},'GeoMestre Brasil'),
        h('h1',null,'Geografia do Brasil com elegância e precisão'),
        h('p',{className:'muted'},'Treine estados e capitais em uma experiência limpa, acessível e focada em aprendizado real.'),
        h('div',{className:'actions-row'},
          h('button',{className:'btn btn-primary',onClick:()=>resetGame('game')},'Iniciar jogo'),
          h('button',{className:'btn btn-secondary',onClick:()=>{state.mode='study';state.feedback='';render()}},'Modo estudo')
        )
      )
    ));
    return;
  }

  if(state.mode==='study'){
    const main=h('main',{className:'container'});
    const sec=h('section',{className:'panel'},
      h('p',{className:'eyebrow'},'Modo estudo'),
      h('h1',null,'Explore o mapa com calma'),
      h('p',{className:'muted'},'Clique em um estado para visualizar a capital.')
    );
    const mapDiv=h('div',{className:'map-panel'});
    renderMap(mapDiv,null,name=>{const s=STATES_BY_NAME[name];state.feedback=`${name}: capital ${s?.capital??'—'}`;render()},true);
    sec.appendChild(mapDiv);
    sec.appendChild(h('p',{className:'feedback'},state.feedback||'Dica: navegue pelos estados com Tab e confirme com Enter.'));
    main.appendChild(sec);
    main.appendChild(h('div',{className:'actions-row'},
      h('button',{className:'btn btn-secondary',onClick:()=>{state.mode='menu';render()}},'Voltar ao menu'),
      h('button',{className:'btn btn-primary',onClick:()=>resetGame('game')},'Jogar agora')
    ));
    app.appendChild(main);
    return;
  }

  // Game mode
  if(ended){
    const main=h('main',{className:'container'});
    const sec=h('section',{className:'panel'},
      h('p',{className:'eyebrow'},'Resultado final'),
      h('h1',null,'Fim de jogo'),
      h('div',{className:'review-grid summary-grid'},
        h('p',{className:'review-item'},h('strong',null,'Pontuação base'),h('span',null,String(state.score))),
        h('p',{className:'review-item'},h('strong',null,'Bônus de tempo'),h('span',null,String(Math.max(0,state.timeLeft)*2))),
        h('p',{className:'review-item'},h('strong',null,'Pontuação final'),h('span',null,String(state.score+Math.max(0,state.timeLeft)*2))),
        h('p',{className:'review-item'},h('strong',null,'Maior sequência'),h('span',null,String(state.streak))),
        h('p',{className:'review-item'},h('strong',null,'Erros'),h('span',null,`${state.errors} / ${MAX_ERRORS}`))
      ),
      h('h2',null,'Resumo pedagógico')
    );
    if(state.wrongAnswers.length){
      const rg=h('div',{className:'review-grid'});
      state.wrongAnswers.forEach(w=>rg.appendChild(h('p',{className:'review-item'},h('strong',null,w.estado),h('span',null,w.capital))));
      sec.appendChild(rg);
    }else{sec.appendChild(h('p',{className:'muted'},'Sem erros. Excelente desempenho.'))}
    sec.appendChild(h('div',{className:'actions-row'},
      h('button',{className:'btn btn-primary',onClick:()=>resetGame('game')},'Jogar novamente'),
      h('button',{className:'btn btn-secondary',onClick:()=>{state.mode='study';render()}},'Revisar no estudo')
    ));
    main.appendChild(sec);
    app.appendChild(main);
    return;
  }

  const cur=state.queue[state.index];
  const main=h('main',{className:'container game-container'});

  // Header
  const header=h('header',{className:'hero panel game-hero'},
    h('div',{className:'game-title-row'},
      h('p',{className:'eyebrow'},'GeoMestre Brasil'),
      h('button',{className:'btn btn-quiet',onClick:()=>{state.showOptions=true;render()}},'⋯')
    ),
    h('div',{className:'hud'},
      h('span',{className:'chip'},h('strong',null,String(state.score)),h('small',null,'pontos')),
      h('span',{className:'chip'},h('strong',null,String(state.streak)),h('small',null,'sequência')),
      h('span',{className:'chip'},h('strong',null,`${state.errors}/${MAX_ERRORS}`),h('small',null,'erros')),
      h('span',{className:'chip'},h('strong',null,`${state.timeLeft}s`),h('small',null,'tempo')),
      h('span',{className:'chip'},h('strong',null,String(Math.min(state.index+1,state.queue.length))),h('small',null,'rodada'))
    ),
    h('div',{className:'progress'},h('span',{style:{width:`${(Math.min(state.index,state.queue.length)/state.queue.length)*100}%`}}))
  );
  main.appendChild(header);

  // Game panel
  const gp=h('section',{className:'panel game-panel'});
  gp.appendChild(h('div',{className:'round-title'},h('h2',null,'Estado destacado'),h('p',{className:'muted'},`Rodada ${state.index+1}`)));
  const mapPanel=h('div',{className:'map-panel game-map-panel'});
  renderMap(mapPanel,cur?.estado);
  gp.appendChild(mapPanel);
  gp.appendChild(h('p',{className:'feedback'},state.feedback||'Toque em "Resposta" para abrir o painel de resposta.'));
  gp.appendChild(h('div',{className:'cta-wrap'},h('button',{className:'btn btn-primary btn-answer',onClick:()=>{state.showAnswerSheet=true;document.body.classList.add('answer-sheet-open');render()}},'Resposta')));
  main.appendChild(gp);

  // Answer sheet overlay
  if(state.showAnswerSheet){
    const overlay=h('div',{className:'overlay answer-overlay'});
    const panel=h('section',{className:'panel overlay-panel answer-panel'});
    panel.appendChild(h('div',{className:'overlay-head'},
      h('h3',null,'Responder rodada'),
      h('button',{className:'btn btn-secondary',onClick:()=>{state.showAnswerSheet=false;document.body.classList.remove('answer-sheet-open');render()}},'Fechar')
    ));
    const miniDiv=h('div',{className:'question-mini-state'});
    renderMiniState(miniDiv,cur?.estado);
    panel.appendChild(miniDiv);

    const stateOpts=state.stateOptions;
    const capitalOpts=state.capitalOptions;
    const fields=h('div',{className:'fields-grid answer-fields'});
    
    // State options
    const sg=h('fieldset',{className:'option-group'});
    sg.appendChild(h('legend',null,'Estado'));
    const sbtns=h('div',{className:'option-buttons'});
    stateOpts.forEach(o=>{
      const b=h('button',{type:'button',className:`option-btn ${state.stateAnswer===o?'is-selected':''}`,onClick:()=>{state.stateAnswer=o;render()}},o);
      sbtns.appendChild(b);
    });
    sg.appendChild(sbtns);
    fields.appendChild(sg);

    // Capital options
    const cg=h('fieldset',{className:'option-group'});
    cg.appendChild(h('legend',null,'Capital'));
    const cbtns=h('div',{className:'option-buttons'});
    capitalOpts.forEach(o=>{
      const b=h('button',{type:'button',className:`option-btn ${state.capitalAnswer===o?'is-selected':''}`,onClick:()=>{state.capitalAnswer=o;render()}},o);
      cbtns.appendChild(b);
    });
    cg.appendChild(cbtns);
    fields.appendChild(cg);
    panel.appendChild(fields);

    const disabled=!normalizeText(state.stateAnswer)||!normalizeText(state.capitalAnswer);
    panel.appendChild(h('div',{className:'answer-actions'},
      h('button',{className:'btn btn-secondary',onClick:()=>{state.stateAnswer='';state.capitalAnswer='';state.showAnswerSheet=false;document.body.classList.remove('answer-sheet-open');render()}},'Cancelar'),
      h('button',{className:'btn btn-primary',onClick:()=>{if(!disabled)submitRound()},disabled},'Confirmar')
    ));
    overlay.appendChild(panel);
    main.appendChild(overlay);
  }

  // Options overlay
  if(state.showOptions){
    const overlay=h('div',{className:'overlay'});
    overlay.appendChild(h('section',{className:'panel overlay-panel'},
      h('div',{className:'overlay-head'},h('h3',null,'Opções'),h('button',{className:'btn btn-secondary',onClick:()=>{state.showOptions=false;render()}},'Fechar')),
      h('div',{className:'overlay-actions'},
        h('button',{className:'btn btn-secondary',onClick:()=>{state.showOptions=false;state.mode='study';render()}},'Modo estudo'),
        h('button',{className:'btn btn-secondary',onClick:()=>{state.showOptions=false;resetGame('menu')}},'Voltar ao menu')
      )
    ));
    main.appendChild(overlay);
  }

  app.appendChild(main);
}

init();
</script>
</body>
</html>
